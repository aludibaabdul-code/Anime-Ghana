<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>News ‚Äî Anime Ghana</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="logo" href="index.html">
        <img src="assets/logo.svg" alt="Anime Ghana logo">
        <span class="site-title">Anime Ghana</span>
      </a>
      <nav>
        <ul class="nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="community.html">Community</a></li>
    <script src="assets/notify.js"></script>
          <li><a href="news.html">News</a></li>
          <li><a href="manga.html">Manga</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </nav>
      <div class="header-utilities">
        <a id="following-link" class="following-link" href="community.html?view=following" style="display:none">Following (<span id="following-count">0</span>)</a>
        <a id="notif-link" class="following-link" href="moderation.html" style="display:none">üîî <span id="notif-count">0</span></a>
      </div>
    </div>
  </header>
  <main class="container">
    <h2 id="page-title">Anime News</h2>
    <p id="page-desc">Latest headlines and updates relevant to Ghanaian fans.</p>

    <div id="news-list" class="news-main">
      <!-- JS will populate anime-specific or general news here -->
    </div>
    
    <script>
      // Small client-side news renderer. It uses the `anime` query param.
      (function(){
        const dataset = {
          'one-piece': {
            title: 'One Piece',
            desc: 'All things Straw Hat ‚Äî episodes, scans, and local meetups.',
            news: [
              {h: 'New episode airs this weekend', p: 'Catch the latest adventures as the crew pushes toward the New World.'},
              {h: 'Community watch party in Accra', p: 'Join fellow fans for a screening and discussion.'}
            ]
          },
          'attack-on-titan': {
            title: 'Attack On Titan',
            desc: 'Updates, theory discussions, and episode breakdowns.',
            news: [
              {h: 'Season finale reactions', p: 'Fans discuss the latest twists and implications.'},
              {h: 'Manga reprint announced', p: 'Collectors can expect new volumes in stores soon.'}
            ]
          },
          'naruto': {
            title: 'Naruto',
            desc: 'Nostalgia, spin-offs and community cosplay highlights.',
            news: [
              {h: 'Cosplay feature: Leaf Village', p: 'Local cosplayers recreate iconic Hokage looks.'},
              {h: 'Top 10 Naruto moments', p: 'A countdown of the most memorable scenes.'}
            ]
          },
          'hxh': {
            title: 'Hunter x Hunter',
            desc: 'Deep dives into Nen and character arcs.',
            news: [
              {h: 'Fan analysis: The Chimera Ant arc', p: 'A longform look at one of the series‚Äô most praised arcs.'},
              {h: 'Community watch: Strategy night', p: 'Join others to debate the latest theories.'}
            ]
          }
          ,
          'bleach': {
            title: 'Bleach',
            desc: 'Soul Society updates, character spotlights and manga news.',
            news: [
              {h: 'Anniversary celebration', p: 'Fans mark key moments from Ichigo‚Äôs journey.'},
              {h: 'New merch release', p: 'Collectible figures and posters arriving in stores.'}
            ],
            links: [
              {label: 'Watch on Crunchyroll', url: 'https://www.crunchyroll.com/series/GR8R8Y1ZV/bleach'},
              {label: 'Read on MangaPlus', url: 'https://mangaplus.shueisha.co.jp/'}
            ]
          },
          'dragon-ball': {
            title: 'Dragon Ball',
            desc: 'From Dragon Ball to Super ‚Äî tournaments, power-ups, and community highlights.',
            news: [
              {h: 'Tournament recap', p: 'Fans debate the biggest clashes from the latest arc.'},
              {h: 'Classic episode marathon', p: 'Local screenings of original Dragon Ball episodes.'}
            ],
            links: [
              {label: 'Watch on Crunchyroll', url: 'https://www.crunchyroll.com/dragon-ball'},
              {label: 'Official site', url: 'https://www.dragonball.com/'}
            ]
          },
          'cowboy-bebop': {
            title: 'Cowboy Bebop',
            desc: 'Neo-noir space western discussions, music breakdowns and reviews.',
            news: [
              {h: 'Soundtrack spotlight', p: 'A closer look at Yoko Kanno‚Äôs unforgettable score.'},
              {h: 'Collector‚Äôs editions', p: 'New Blu-ray releases and limited box sets.'}
            ],
            links: [
              {label: 'Watch on Hulu', url: 'https://www.hulu.com/series/cowboy-bebop'},
              {label: 'Wikipedia', url: 'https://en.wikipedia.org/wiki/Cowboy_Bebop'}
            ]
          },
          'gachiakuta': {
            title: 'Gachiakuta',
            desc: 'Featured entry ‚Äî placeholder; replace with real series name if needed.',
            news: [
              {h: 'Feature spotlight', p: 'Community highlights and fan art.'}
            ],
            links: [
              {label: 'Search web', url: 'https://www.google.com/search?q=gachiakuta'}
            ]
          }
          ,
          'jujutsu-kaisen': {
            title: 'Jujutsu Kaisen',
            desc: 'High-energy supernatural shonen known for its fluid fights and strong characters.',
            news: [
              {h: 'New season discussions', p: 'Community reacts to the latest episodes and fight choreography.'},
              {h: 'Cosplay spotlight', p: 'Local cosplayers bring out Gojo and Yuji looks at recent events.'}
            ],
            links: [
              {label: 'Search on Crunchyroll', url: 'https://www.crunchyroll.com/search?from=search&q=jujutsu%20kaisen'},
              {label: 'MyAnimeList', url: 'https://myanimelist.net/anime/40748/Jujutsu_Kaisen'}
            ]
          },
          'solo-leveling': {
            title: 'Solo Leveling',
            desc: 'Action-heavy adaptation of the popular webnovel/manhwa; trending in international fan communities.',
            news: [
              {h: 'Fan art and AMVs trending', p: 'New fan works inspired by the series are circulating widely.'},
              {h: 'Merch round-up', p: 'Collectible releases and preorder windows announced by vendors.'}
            ],
            links: [
              {label: 'Search web', url: 'https://www.google.com/search?q=solo+leveling+watch'},
              {label: 'Webtoon / Official', url: 'https://www.webtoons.com/'}
            ]
          }
        };

        const params = new URLSearchParams(location.search);
        const slug = params.get('anime');
        const searchQ = (params.get('search') || '').trim();
        const list = document.getElementById('news-list');
        const pageTitle = document.getElementById('page-title');
        const pageDesc = document.getElementById('page-desc');

        function matchesQuery(text){
          return text.toLowerCase().indexOf(searchQ) !== -1;
        }

        function renderGeneral(){
          pageTitle.textContent = 'Anime News';
          pageDesc.textContent = 'Latest headlines and updates relevant to Ghanaian fans.';
          list.innerHTML = '';
          // Trending shortcut to Crunchyroll
          const trendingWrap = document.createElement('div');
          trendingWrap.style.marginBottom = '12px';
          trendingWrap.innerHTML = `<p><strong>Trending on Crunchyroll:</strong> <a class="ext-btn" href="https://www.crunchyroll.com/videos/anime" target="_blank" rel="noopener noreferrer">See trending anime on Crunchyroll</a></p>`;
          list.appendChild(trendingWrap);
          // render top-150 section (will load from cache or fetch in background)
          try{ renderTopAnimeSection(list, trendingWrap); }catch(e){ console.warn('top-anime render failed', e); }
          Object.keys(dataset).forEach(k=>{
            const item = dataset[k];
            if(searchQ){
              // filter by title, desc or news text
              const combined = (item.title + ' ' + item.desc + ' ' + item.news.map(n=>n.h+' '+n.p).join(' ')).toLowerCase();
              if(!combined.includes(searchQ)) return;
            }
            const el = document.createElement('article');
            el.className = 'news-item';
            el.innerHTML = `<h3><a href="news.html?anime=${k}">${item.title}</a></h3><p>${item.desc}</p>`;
            list.appendChild(el);
          });
          if(searchQ && list.children.length===0){
            list.innerHTML = '<p>No results found for "'+searchQ+'". Try searching for one-piece, naruto, or hxh.</p>';
          }
          // Render auto-generated trending posts (from community.js generator)
          try{
            const auto = JSON.parse(localStorage.getItem('agh_autonews')||'[]');
            if(auto && auto.length){
              const wrap = document.createElement('div'); wrap.className = 'news-auto-trending'; wrap.innerHTML = '<h3>Trending Now</h3>';
              auto.slice(0,6).forEach(a=>{ const el = document.createElement('article'); el.className='news-item'; el.innerHTML = `<h4>${a.title}</h4><p class="muted">Source ‚Ä¢ ${new Date(a.at).toLocaleString()}</p><p>${a.body}</p>`; wrap.appendChild(el); });
              list.insertBefore(wrap, list.firstChild);
            }
          }catch(e){/* ignore */}
        }

        /* Top-150 anime: fetch once and store as a local constant in localStorage
           - Stored under 'agh_top150_anime' as an array of {mal_id,title,image,url,synopsis}
           - Rendered into a black background section with cards. */
        function slugifyTitle(t){ return (t||'').toLowerCase().replace(/[^ -]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

        async function ensureTop150(){
          try{
            const existing = JSON.parse(localStorage.getItem('agh_top150_anime')||'null');
            if(existing && Array.isArray(existing) && existing.length>=150) return existing;
          }catch(e){ /* fallthrough to fetch */ }
          // fetch top pages sequentially until we have ~150 items
          const out = [];
          for(let page=1; out.length < 150 && page <= 8; page++){
            try{
              const r = await fetch('https://api.jikan.moe/v4/top/anime?page='+page);
              if(!r.ok) { console.warn('Jikan top fetch failed', r.status); break; }
              const j = await r.json();
              (j.data||[]).forEach(it=>{
                if(out.length>=150) return;
                out.push({ mal_id: it.mal_id, title: it.title, image: it.images?.jpg?.image_url || it.images?.webp?.image_url || '', url: it.url || '', synopsis: it.synopsis || '' });
              });
              // small pause to be gentle on the API
              await new Promise(res=>setTimeout(res, 220));
            }catch(err){ console.warn('top fetch error', err); break; }
          }
          if(out.length) localStorage.setItem('agh_top150_anime', JSON.stringify(out));
          return out;
        }

        function renderTopAnimeSection(listEl, afterNode){
          // create container slot
          let section = document.getElementById('top-anime');
          if(!section){
            section = document.createElement('section');
            section.id = 'top-anime';
            section.className = 'top-anime-section';
            section.innerHTML = `<div class="top-anime-inner"><h3>Top 150 Anime</h3><p class="muted">Curated list (cached locally) ‚Äî click a card to view news for that show.</p><div class="top-anime-grid" aria-live="polite"></div><div style="text-align:center;margin-top:12px"><button class="btn" id="top-anime-toggle">Show more</button></div></div>`;
            if(afterNode && afterNode.parentNode) afterNode.parentNode.insertBefore(section, afterNode.nextSibling);
            else listEl.insertBefore(section, listEl.firstChild);
          }
          const grid = section.querySelector('.top-anime-grid');
          grid.innerHTML = '<div class="muted">Loading top anime (cached)...</div>';
          // read from cache first
          let cached = [];
          try{ cached = JSON.parse(localStorage.getItem('agh_top150_anime')||'[]'); }catch(e){ cached = []; }
          function renderCards(arr, limit){
            grid.innerHTML = '';
            const slice = (limit? arr.slice(0,limit): arr);
            slice.forEach(it=>{
              const a = document.createElement('a');
              a.className = 'top-anime-card';
              a.href = 'news.html?anime='+encodeURIComponent(slugifyTitle(it.title));
              a.innerHTML = `
                <div class="thumb"><img src="${it.image||''}" alt="${it.title} poster" loading="lazy"></div>
                <div class="top-card-body"><h4>${it.title}</h4><p>${(it.synopsis||'').slice(0,140)}${(it.synopsis && it.synopsis.length>140)?'...':''}</p></div>
              `;
              grid.appendChild(a);
            });
          }
          // if we have cached items, render initial subset
          if(cached && cached.length){ renderCards(cached, 12); }
          // wire toggle to expand to show many
          const toggle = section.querySelector('#top-anime-toggle');
          let expanded = false;
          toggle.addEventListener('click', async ()=>{
            if(!expanded){
              // if we don't have many cached, ensure fetch
              let data = cached;
              if(!data || data.length < 150){ data = await ensureTop150(); cached = data || cached; }
              renderCards(cached, 150);
              toggle.textContent = 'Show less';
              expanded = true;
            } else {
              renderCards(cached, 12);
              toggle.textContent = 'Show more';
              expanded = false;
            }
          });
          // background fetch to populate cache if empty
          if(!cached || cached.length < 150){
            ensureTop150().then(res=>{ cached = res||cached; renderCards(cached, 12); }).catch(()=>{});
          }
        }

        function renderAnime(slug){
          const data = dataset[slug];
          if(!data){ renderGeneral(); return; }
          pageTitle.textContent = data.title + ' ‚Äî News';
          pageDesc.textContent = data.desc;
          list.innerHTML = '';

          // Local image map: prefer user-provided images when available
          const localImages = {
            'one-piece': 'one pi√®ce.jpg',
            'attack-on-titan': 'poster de attack On Titan.jpg',
            'naruto': 'download.jpg',
            'hxh': 'My Anime For Life.jpg',
            'bleach': 'bleach.jpg',
            'dragon-ball': 'Dragonball Z.jpg',
            'cowboy-bebop': 'anime.png',
            'gachiakuta': 'gachaiakuta.jpg',
            'jujutsu-kaisen': 'jujutsu kaisen.jpg',
            'solo-leveling': 'solo leveling.jpg'
          };

          const imgFile = localImages[slug];
          if(imgFile){
            const banner = document.createElement('div');
            banner.innerHTML = `<img src="${imgFile}" alt="${data.title} poster" style="width:100%;max-height:420px;object-fit:cover;border-radius:10px;margin-bottom:12px">`;
            list.appendChild(banner);
          }

          // Likes storage helpers (keyed by slug::index)
          function loadLikes(){ try{return JSON.parse(localStorage.getItem('agh_likes')||'{}')}catch(e){return{}} }
          function saveLikes(o){ localStorage.setItem('agh_likes', JSON.stringify(o)) }
          function loadUserLikes(){ try{ const u = JSON.parse(localStorage.getItem('agh_user')||'null'); if(u){ const id = u.provider+':'+(u.name||u.provider); return JSON.parse(localStorage.getItem('agh_user_likes_'+id)||'[]') } return JSON.parse(localStorage.getItem('agh_user_likes')||'[]') }catch(e){return[]} }
          function saveUserLikes(a){ try{ const u = JSON.parse(localStorage.getItem('agh_user')||'null'); if(u){ const id = u.provider+':'+(u.name||u.provider); localStorage.setItem('agh_user_likes_'+id, JSON.stringify(a)); return } localStorage.setItem('agh_user_likes', JSON.stringify(a)); }catch(e){ } }

          data.news.forEach((n,i)=>{
            const key = slug+'::'+i;
            const likes = loadLikes();
            const userLikes = loadUserLikes();
            const count = likes[key]||0;
            const liked = userLikes.indexOf(key)!==-1;

            const el = document.createElement('article');
            el.className = 'news-item';
            el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>${n.h}</h3><button class="like-btn ${liked? 'liked':''}" data-key="${key}">‚ù§ ${count}</button></div><p>${n.p}</p>`;
            list.appendChild(el);
          });
          // external links (watch/read) if provided
          if(data.links && data.links.length){
            const wrap = document.createElement('div');
            wrap.className = 'external-links';
            data.links.forEach(l=>{
              const a = document.createElement('a');
              a.className = 'ext-btn';
              a.href = l.url;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.textContent = l.label;
              wrap.appendChild(a);
            });
            list.appendChild(wrap);
          }
          // small back link
          const back = document.createElement('p');
          back.innerHTML = `<a href="index.html">&larr; Back to Home</a>`;
          list.appendChild(back);
          // attach like handlers
          document.querySelectorAll('.like-btn').forEach(b=>b.addEventListener('click', e=>{
            const key = e.currentTarget.dataset.key;
            const likes = loadLikes();
            const userLikes = loadUserLikes();
            const idx = userLikes.indexOf(key);
            if(idx !== -1){
              // remove like
              userLikes.splice(idx,1);
              likes[key] = Math.max(0,(likes[key]||1)-1);
            } else {
              userLikes.push(key);
              likes[key] = (likes[key]||0)+1;
            }
            saveLikes(likes); saveUserLikes(userLikes);
            // update button UI
            const btn = document.querySelector(`.like-btn[data-key="${key}"]`);
            if(btn){ btn.textContent = '‚ù§ '+(likes[key]||0); btn.classList.toggle('liked', userLikes.indexOf(key)!==-1); }
            // keep likes per-user private: store user-specific liked keys under 'agh_user_likes_<userid>' and keep global counts in 'agh_likes'
            try{
              const u = JSON.parse(localStorage.getItem('agh_user')||'null');
              if(u){
                const uid = u.provider+':'+(u.name||u.provider);
                localStorage.setItem('agh_user_likes_'+uid, JSON.stringify(userLikes));
              } else {
                localStorage.setItem('agh_user_likes', JSON.stringify(userLikes));
              }
            }catch(e){}
          }));
        }

        // If there's a search query, first try Jikan API (MyAnimeList) to show image + description
        async function renderSearch(q){
          pageTitle.textContent = 'Search: '+q;
          pageDesc.textContent = 'Results from MyAnimeList (via Jikan).';
          list.innerHTML = '';
          const container = document.createElement('div');
          container.className = 'jikan-results';
          list.appendChild(container);

          try{
            const res = await fetch('https://api.jikan.moe/v4/anime?q='+encodeURIComponent(q)+'&limit=6');
            if(!res.ok) throw new Error('Jikan error: '+res.status);
            const json = await res.json();
            const results = json.data || [];
            if(results.length===0){
              list.innerHTML = `<p>No results found for "${q}" via Jikan. Try a different term.</p>`;
              return;
            }
            results.forEach(item=>{
              const card = document.createElement('article');
              card.className = 'jikan-card';
              const img = (item.images && (item.images.jpg?.image_url || item.images.webp?.image_url)) || '';
              card.innerHTML = `
                ${img? `<img src="${img}" alt="${item.title} poster">` : ''}
                <div class="body">
                  <h4>${item.title}</h4>
                  <p>${(item.synopsis||'No description available.').replace(/\n/g,' ')} </p>
                  <a class="more" href="${item.url}" target="_blank" rel="noopener noreferrer">View on MyAnimeList</a>
                </div>
              `;
              container.appendChild(card);
            });
            // also include site announcements at top
            const ann = (function(){ try{return JSON.parse(localStorage.getItem('agh_announcements')||'[]')}catch(e){return[]} })();
            if(ann && ann.length){
              const wrap = document.createElement('div'); wrap.style.marginTop='14px'; wrap.innerHTML = `<h3>Announcements</h3>`;
              ann.slice(0,5).forEach(a=>{ const el = document.createElement('article'); el.className='news-item'; el.innerHTML = `<h4>${a.title}</h4><p class="muted">${a.author} ‚Ä¢ ${new Date(a.at).toLocaleString()}</p><p>${a.body}</p>`; wrap.appendChild(el); });
              list.insertBefore(wrap, container);
            }
          }catch(err){
            console.error(err);
            list.innerHTML = `<p>Unable to fetch results from Jikan: ${err.message}. Showing local matches instead.</p>`;
            renderGeneral();
          }
        }

        if(searchQ){
          // if user provided a search, use Jikan to fetch and display results
          renderSearch(searchQ);
        } else if(slug){
          renderAnime(slug);
        } else { 
          renderGeneral();
          // show announcements at top of general list
          const anns = (function(){ try{return JSON.parse(localStorage.getItem('agh_announcements')||'[]')}catch(e){return[]} })();
          if(anns && anns.length){
            const wrapper = document.createElement('div'); wrapper.className = 'announcements'; wrapper.innerHTML = '<h3>Announcements</h3>';
            anns.slice(0,5).forEach(a=>{ 
              const el = document.createElement('article'); 
              el.className = 'announcement-item news-item';
              el.innerHTML = `<h4>${a.title}</h4><p class="muted">${a.author} ‚Ä¢ ${new Date(a.at).toLocaleString()}</p><p>${a.body}</p>`;
              wrapper.appendChild(el);
            });
            const listEl = document.getElementById('news-list'); if(listEl) listEl.insertBefore(wrapper, listEl.firstChild);
          }
        }
      })();
    </script>

    <!-- News blog UI: post form, comments/debate, and verification controls -->
    <div id="news-post-area"></div>
    <script>
      (function(){
        function safeParse(k){ try{ return JSON.parse(localStorage.getItem(k)||'null') }catch(e){ return null } }
        function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
        function currentUser(){ try{ return JSON.parse(localStorage.getItem('agh_user')||'null') }catch(e){ return null } }
        function isModerator(){ return localStorage.getItem('agh_is_admin') === 'true' }

        function loadNewsPosts(){ return safeParse('agh_news_posts') || [] }
        function saveNewsPosts(a){ save('agh_news_posts', a) }

        function loadVerifiedUsers(){ return safeParse('agh_verified_users') || [] }
        function saveVerifiedUsers(a){ save('agh_verified_users', a) }
        function loadVerifiedAnime(){ return safeParse('agh_verified_anime') || [] }
        function saveVerifiedAnime(a){ save('agh_verified_anime', a) }

        function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[c])); }

        // render post creation form for signed-in users
        function renderPostForm(){
          const area = document.getElementById('news-post-area'); if(!area) return;
          const user = currentUser();
          if(!user){ area.innerHTML = '<p class="muted">Sign in to write news posts and start a debate.</p>'; return; }
          area.innerHTML = `
            <form id="news-post-form" class="news-post-form">
              <label><strong>Create an article or blog post</strong></label>
              <input id="news-title" type="text" placeholder="Headline" required />
              <select id="news-anime"><option value="">‚Äî Tag an anime (optional) ‚Äî</option></select>
              <select id="news-community"><option value="">‚Äî Post to community (optional) ‚Äî</option></select>
              <textarea id="news-body" placeholder="Write your article or post..." required></textarea>
              <div style="display:flex;gap:8px;margin-top:8px"><button class="post-btn" type="submit">Publish</button><button class="post-btn" type="button" id="news-clear">Clear drafts</button></div>
            </form>
          `;
          // populate anime selector from cached top150
          try{
            const select = document.getElementById('news-anime');
            const top = safeParse('agh_top150_anime') || [];
            top.slice(0,200).forEach(it=>{ const opt = document.createElement('option'); opt.value = (it.title||''); opt.textContent = it.title; select.appendChild(opt); });
          }catch(e){ }
          // populate community selector from local communities
          try{
            const csel = document.getElementById('news-community');
            const comms = safeParse('agh_communities') || [];
            comms.forEach(c=>{ const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.title; csel.appendChild(opt); });
          }catch(e){}

          document.getElementById('news-post-form').addEventListener('submit', e=>{
            e.preventDefault();
            const title = document.getElementById('news-title').value.trim();
            const body = document.getElementById('news-body').value.trim();
            const anime = document.getElementById('news-anime').value.trim();
            const community = (document.getElementById('news-community')||{}).value || '';
            if(!title || !body) return;
            const posts = loadNewsPosts();
            const p = { id: String(Date.now())+'-'+Math.random().toString(36).slice(2,8), title, body, anime: anime||'', community: community||'', author: user.name, created: Date.now(), status: isModerator() ? 'approved' : 'pending' };
            posts.push(p); saveNewsPosts(posts);
            renderNewsPosts(); document.getElementById('news-post-form').reset();
          });
          document.getElementById('news-clear').addEventListener('click', ()=>{ if(confirm('Clear local news drafts?')){ document.getElementById('news-post-form').reset(); } });
        }

        // render posts and comments
        function renderNewsPosts(){
          const list = document.getElementById('news-list'); if(!list) return;
          const posts = loadNewsPosts().slice().reverse();
          const params = new URLSearchParams(location.search);
          const slug = params.get('anime');
          const user = currentUser();
          const verifiedUsers = loadVerifiedUsers();

          const visible = posts.filter(p=>{ if(p.status==='approved') return true; if(isModerator()) return true; if(user && user.name === p.author) return true; return false; });

          // remove any previously rendered post-list so we can re-append
          const existingAuto = list.querySelector('.news-posts-list'); if(existingAuto) existingAuto.remove();
          const container = document.createElement('div'); container.className = 'news-posts-list';
          if(visible.length===0){ container.innerHTML = '<p class="muted">No articles yet ‚Äî write one above to start a discussion.</p>'; }
          visible.forEach(p=>{
            if(slug && p.anime && p.anime.toLowerCase().indexOf(slug.replace(/[-_]/g,' '))===-1) return; // filter when viewing anime
            const el = document.createElement('article'); el.className = 'news-item';
            const verified = verifiedUsers.indexOf(p.author)!==-1;
            el.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="author-row"><strong>${escapeHtml(p.title)}</strong>${ verified? '<span class="verified-badge">VERIFIED</span>':'' }</div>
                  <div class="muted">by ${escapeHtml(p.author)} ‚Ä¢ ${new Date(p.created).toLocaleString()} ${p.anime? ' ‚Ä¢ tagged: '+escapeHtml(p.anime):''}</div>
                </div>
                <div>
                  ${ isModerator() ? `<button class="verify-btn" data-verify-user="${escapeHtml(p.author)}">${ verified? 'Unverify':'Verify' }</button>` : '' }
                  ${ p.status && p.status!=='approved' ? `<span class="muted" style="margin-left:8px">${p.status}</span>` : '' }
                </div>
              </div>
              <p style="margin-top:8px">${escapeHtml(p.body)}</p>
              <div style="display:flex;gap:8px;margin-top:8px"><button class="post-btn" data-comment-open="${p.id}">Comment</button><button class="post-btn" data-delete="${p.id}">Delete</button></div>
              <div id="news-comments-${p.id}" style="display:none;margin-top:8px"></div>
            `;
            container.appendChild(el);
          });

          list.appendChild(container);

          // bind verify user
          container.querySelectorAll('[data-verify-user]').forEach(b=>b.addEventListener('click', e=>{
            if(!isModerator()) return alert('Moderator only');
            const author = e.currentTarget.dataset.verifyUser;
            const listV = loadVerifiedUsers();
            const idx = listV.indexOf(author);
            if(idx===-1) { listV.push(author); saveVerifiedUsers(listV); }
            else { listV.splice(idx,1); saveVerifiedUsers(listV); }
            renderNewsPosts();
          }));

          // bind delete
          container.querySelectorAll('[data-delete]').forEach(b=>b.addEventListener('click', e=>{
            const id = e.currentTarget.dataset.delete; const all = loadNewsPosts(); const post = all.find(x=>x.id===id); if(!post) return;
            const user = currentUser(); if(!(isModerator() || (user && user.name===post.author))) return alert('Only author or moderator can delete');
            const filtered = all.filter(x=>x.id!==id); saveNewsPosts(filtered); renderNewsPosts();
          }));

          // comment toggle and rendering
          container.querySelectorAll('[data-comment-open]').forEach(b=>b.addEventListener('click', e=>{
            const id = e.currentTarget.dataset.commentOpen; const div = document.getElementById('news-comments-'+id); if(!div) return; const visible = div.style.display !== 'none'; div.style.display = visible? 'none':'block'; if(visible) return;
            const comments = safeParse('agh_news_comments_'+id) || [];
            div.innerHTML = '';
            const listC = document.createElement('div'); listC.style.display='grid'; listC.style.gap='8px';
            comments.forEach(c=>{ const el = document.createElement('div'); el.className='post-card'; el.innerHTML = `<div class="card-body"><div class="muted">${new Date(c.at).toLocaleString()} ‚Ä¢ ${escapeHtml(c.author)}</div><p>${escapeHtml(c.text)}</p></div>`; listC.appendChild(el); });
            div.appendChild(listC);
            const frm = document.createElement('div'); frm.innerHTML = `<textarea id="news-comment-input-${id}" placeholder="Write a comment" style="width:100%;min-height:60px"></textarea><div style="display:flex;gap:8px;margin-top:6px"><button class="post-btn" id="news-comment-send-${id}">Reply</button></div>`;
            div.appendChild(frm);
            document.getElementById('news-comment-send-'+id).addEventListener('click', ()=>{ const txt = document.getElementById('news-comment-input-'+id).value.trim(); if(!txt) return; const u = currentUser(); const c = { id: String(Date.now()), text: txt, at: Date.now(), author: u?u.name:'Anon' }; comments.push(c); save('agh_news_comments_'+id, comments); renderNewsPosts(); });
          }));
        }

        // when viewing an anime slug, show verify-anime control and badge
        function injectVerifyAnime(){
          const params = new URLSearchParams(location.search); const slug = params.get('anime'); if(!slug) return;
          const v = loadVerifiedAnime(); const isV = v.indexOf(slug)!==-1;
          const titleEl = document.getElementById('page-title'); if(!titleEl) return;
          // remove any existing badge/button to avoid duplicates
          titleEl.querySelectorAll('.verified-badge, .verify-btn').forEach(n=>n.remove());
          if(isV){ const b = document.createElement('span'); b.className='verified-badge'; b.textContent='ORIGINAL'; titleEl.appendChild(b); }
          if(isModerator()){
            const btn = document.createElement('button'); btn.className='verify-btn'; btn.style.marginLeft='8px'; btn.textContent = isV? 'Unverify Anime' : 'Verify Anime';
            btn.addEventListener('click', ()=>{
              const arr = loadVerifiedAnime(); const idx = arr.indexOf(slug);
              if(idx===-1){ arr.push(slug); saveVerifiedAnime(arr); btn.textContent='Unverify Anime'; }
              else { arr.splice(idx,1); saveVerifiedAnime(arr); btn.textContent='Verify Anime'; }
              injectVerifyAnime();
            });
            titleEl.appendChild(btn);
          }
        }

        // initialize
        renderPostForm(); renderNewsPosts(); injectVerifyAnime();
        window.AGNews = { renderNewsPosts, renderPostForm, injectVerifyAnime };
      })();
    </script>
  </main>
  <footer class="site-footer"><div class="container"><p>&copy; 2025 Anime Ghana</p></div></footer>
  <script>
    // header following count updater (shared)
    (function(){
      function updateFollowingCount(){
        try{
          const u = JSON.parse(localStorage.getItem('agh_user')||'null');
          if(!u){ document.querySelectorAll('#following-count').forEach(el=>el.textContent = 0); document.querySelectorAll('#following-link').forEach(el=>el.style.display='none'); return; }
          const id = u.provider+':'+(u.name||u.provider);
          const follows = JSON.parse(localStorage.getItem('agh_follows_'+id)||'[]');
          document.querySelectorAll('#following-count').forEach(el=>el.textContent = follows.length);
          document.querySelectorAll('#following-link').forEach(el=>el.style.display='inline-flex');
        }catch(e){}
      }
      updateFollowingCount();
      window.addEventListener('storage', updateFollowingCount);
    })();
  </script>
</body>
</html>
